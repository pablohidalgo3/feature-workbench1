---
import Layout from "../layouts/Layout.astro";
import { CALENDAR_API_ENDPOINT } from "astro:env/server";

// Fetch upcoming matches at build time or server-side render
const res = await fetch(CALENDAR_API_ENDPOINT);
const matches = await res.json();

/**
 * Devuelve un string con el tiempo restante hasta dateString,
 * omitiendo las unidades que sean cero.
 */
 function getRemaining(dateString: string | number | Date) {
  const target = new Date(dateString);
  const now = new Date();
  let diff = target.getTime() - now.getTime();
  if (diff <= 0) return "0 segundos";
  const units = [];

  const w = Math.floor(diff / (1000 * 60 * 60 * 24 * 7));
  if (w) units.push(`${w} ${w === 1 ? "semana" : "semanas"}`);
  diff %= 1000 * 60 * 60 * 24 * 7;

  const d = Math.floor(diff / (1000 * 60 * 60 * 24));
  if (d) units.push(`${d} ${d === 1 ? "día" : "días"}`);
  diff %= 1000 * 60 * 60 * 24;

  const h = Math.floor(diff / (1000 * 60 * 60));
  if (h) units.push(`${h} ${h === 1 ? "hora" : "horas"}`);
  diff %= 1000 * 60 * 60;

  const m = Math.floor(diff / (1000 * 60));
  if (m) units.push(`${m} ${m === 1 ? "minuto" : "minutos"}`);
  diff %= 1000 * 60;

  const s = Math.floor(diff / 1000);
  if (s) units.push(`${s} ${s === 1 ? "segundo" : "segundos"}`);

  return units.join(" ");
}
---

<Layout
  title="G2 History Calendar"
  description="Consulta el calendario de partidos de G2 Esports."
  image="/g2_logo.png"
  url="https://www.g2leaguehistory.online/calendar"
>
<h1 class="text-3xl font-bold text-center mb-10">Upcoming matches</h1>
  {matches.length > 0 ? (
    <div class="grid gap-6 grid-cols-1 md:grid-cols-2 lg:grid-cols-3 justify-items-center">
      {matches.map((match: { matchPage: string | URL | null | undefined; team1Logo: string | null | undefined; team1: unknown; team2Logo: string | null | undefined; team2: unknown; bo: unknown; date: unknown; streams: { twitch: string | URL | null | undefined; youtube: string | URL | null | undefined; }; tournament: { url: string | URL | null | undefined; name: unknown; }; }) => (
        <div
          class="w-full max-w-sm bg-white dark:bg-gray-800 rounded-xl shadow-md overflow-hidden flex flex-col items-center p-6"
          data-id={match.matchPage}
        >
          <div class="flex items-center w-full justify-center space-x-2 mb-4">
            <div class="flex flex-col items-center">
              <img src={match.team1Logo} alt={String(match.team1)} class="w-16 h-16 object-contain mb-2" />
              <span class="font-semibold text-lg">{match.team1}</span>
            </div>
            <span class="text-2xl font-bold">vs</span>
            <div class="flex flex-col items-center">
              <img src={match.team2Logo} alt={String(match.team2)} class="w-16 h-16 object-contain mb-2" />
              <span class="font-semibold text-lg">{match.team2}</span>
            </div>
          </div>

          <div class="w-full text-center space-y-2 text-gray-700 dark:text-gray-300">
            <p><strong>Format:</strong> {match.bo}</p>
            <p><strong>Date:</strong> {match.date}</p>
            <p><strong>Remaining:</strong> {getRemaining(match.date as string | number | Date)}</p>
            <p class="flex items-center justify-center space-x-4">
              <strong>Streams:</strong>
              {match.streams.twitch && (
                <a href={match.streams.twitch} target="_blank" rel="noopener noreferrer" class="inline-flex items-center space-x-1">
                  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" class="w-5 h-5">
                    <path d="M4.5 2L2 6v14h6v4l4-4h5l5-5V2H4.5z" fill="currentColor" />
                  </svg>
                  <span>Twitch</span>
                </a>
              )}
              {match.streams.youtube && (
                <a href={match.streams.youtube} target="_blank" rel="noopener noreferrer" class="inline-flex items-center space-x-1">
                  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" class="w-5 h-5">
                    <path d="M10 15l5.19-3L10 9v6zm12-3c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V7c0-1.1.9-2 2-2h16c1.1 0 2 .9 2 2v5z" fill="currentColor" />
                  </svg>
                  <span>YouTube</span>
                </a>
              )}
            </p>
            <p>
              <strong>Tournament:</strong>
              <a
                href={match.tournament.url}
                target="_blank"
                rel="noopener noreferrer"
                class="text-blue-600 dark:text-blue-400 ml-1"
              >
                {match.tournament.name}
              </a>
            </p>
          </div>
        </div>
      ))}
    </div>
  ) : (
    <p class="text-center text-gray-600 dark:text-gray-400">No hay próximos partidos registrados.</p>
  )}
</Layout>
